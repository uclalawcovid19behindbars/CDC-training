---
title: "CDC Data Training #2"
author: "UCLA Law COVID-19 Behind Bars Data Project"
date: "April 2021"
output: 
  html_document:
    toc: true
    toc_float: true
---

## Introduction

We will cover a number of topics in this training around how to use the UCLA Law COVID-19 Behind Bars Data Project's data for analysis and visualization purposes. You can expect to leave with a better understanding of how to perform comparative analyses amongst carceral facilities along axes such as gender, public/private status, and state. We will also cover how to merge the UCLA data set with external datasets such as the BJS, or Bureau of Justice Statistics, data. 

There is no prior experience using the R programming language required for this training. For ease of use, we recommend opening this R Markdown file and following along within the RStudio application.

## Loading Packages

The code below loads in a few R packages that we'll use to manipulate the data in this session. A package bundles together code and documentation, and allows you to access helpful pre-written functions. To learn more about the most widely-used R packages, feel free to visit [this page](https://www.rstudio.com/products/rpackages/).

```{r package setup, message=FALSE, warning=FALSE}
## NB: if we clean up and save BJS data ahead of time, remove "haven" and "sjlabelled" from this list

## install packages by un-commenting the line below (only do this one time) 
# install.packages(c("tidyverse", "devtools", "skimr", "haven", "sjlabelled", "stringr))
## load packages into session
## do this every time you re-start R 
library(tidyverse) 
library(devtools)
library(skimr)
library(haven)
library(sjlabelled)
library(stringr)
```

The UCLA data team wrote a custom R package to help work with our data. You can read more about the package's functionality in the repository homepage, here: https://github.com/uclalawcovid19behindbars/behindbarstools.

```{r, message=FALSE, warning=FALSE}
## install UCLA package
devtools::install_github("uclalawcovid19behindbars/behindbarstools")
## load UCLA package into session
library(behindbarstools) 
## load the UCLA package documentation
help(package=behindbarstools) 
```

## Load Data

Our latest data presents a snapshot in time of cumulative infections, deaths, recoveries, and other variables across states and jurisdictions. To load in the latest facility-level data, run the code below. 

Note that our [data repository](https://github.com/uclalawcovid19behindbars/data/tree/master/latest-data) has state-aggregated and nationally-aggregated counts available in separate data sheets. 

```{r, message=FALSE, warning=FALSE}
## should we use read_scrape_data for this? or load directly from github? 

## if this option, walk through how to get to the "raw" data from the data repo 
# latest_data <- read_csv("https://raw.githubusercontent.com/uclalawcovid19behindbars/data/master/latest-data/adult_facility_covid_counts.csv")
latest_data <- read_scrape_data(all_dates = FALSE)
```

For some states, you can also access historical data for all of the state-run facilities for which we collect data. To read in the historical data for the state of California, run the code below.

```{r, message=FALSE, warning=FALSE}
ca_historical <- read_csv("https://raw.githubusercontent.com/uclalawcovid19behindbars/historical-data/main/data/CA-historical-data.csv")
```

## Explore Data

I like using the `skim()` function to get a quick glance at any data. You can also view the variable names by calling the function `names()`.

```{r, message=FALSE, warning=FALSE}
skim(latest_data)
names(latest_data)
```

To dig more into the variables, we can use functions like `table()` and `count()`. We use the pipe, `%>%`, to demonstrate a sequence of functions being called on the top-most data object. To read more about pipes, check out the [documentation here](https://magrittr.tidyverse.org/reference/pipe.html).

```{r, message=FALSE, warning=FALSE}
## what unique values exist for the variable "jurisdiction"?
table(latest_data$Jurisdiction)
## how many entities were observed from each state on the most recent scrape?
latest_data %>% 
  count(State)

## add "arrange" to the sequence of pipes to view the counts in order
latest_data %>%
  count(State) %>%
  arrange(desc(n))
```


## Filter Data 

We have a lot of different types of facilities in our data set. To create a somewhat comparable group of facilities across the states, we filter to facilities that have had more than 25 COVID-19 infections among the incarcerated populations. 

We also want to filter out jails, since they function quite differently than prisons, and we only collect the largest jails in the US. 

```{r, message=FALSE, warning=FALSE}
## add any other data filters to this?

## number of observations
nrow(latest_data)

## note missing data 
table(is.na(latest_data$Residents.Confirmed))
table(is.na(latest_data$Residents.Population))

filtered_data <- latest_data %>%
  filter(Residents.Confirmed > 24) %>% # filter out prisons with less than 25 infections
  filter(Jurisdiction != "county")

nrow(filtered_data) # filtered out ~730 observations
```

Towards the goal of comparing facilities of different sizes, we calculate infection rates using the population from February 2020 as our denominator, and the cumulative number of COVID-19 infections among the incarcerated population as the numerator.

```{r, message=FALSE, warning=FALSE}
filtered_data <- filtered_data %>%
  mutate(confirmed_rate = Residents.Confirmed / Population.Feb20) 

## notice that some values are NA because of missing values in the denominator 
table(is.na(filtered_data$confirmed_rate)) 
table(is.na(filtered_data$Residents.Confirmed))
```

## Merge Data 

There is lots of helpful info contained within the BJS, or Bureau of Justice Statistics', data on prisons. We supply the BJS ID number for all facilities when it's identifiable. We can use the BJS ID to merge our data with the BJS data set. 

```{r, message=FALSE, warning=FALSE}
table(is.na(filtered_data$BJS.ID)) ## BJS IDs present for about 2/3 of our data

## read in the BJS data
## should we host this data somewhere? if so, replace this path with a stable link
## downloaded "STATA" verison of the data here: https://www.icpsr.umich.edu/web/NACJD/studies/37294# 
bjs_data_path <- file.path("~", "UCLA", "misc-data", "BJS", 
                           "ICPSR_37294", "DS0001","37294-0001-Data.dta")
bjs_raw <- haven::read_dta(bjs_data_path)
names(bjs_raw)
```
It's hard to use this data when the variable names are so opaque! This data is *labelled*, meaning that the variable names and values are encoded in special ways. We use the `sjlabelled` and `haven` packages to make the BJS data more user-friendly. For more on working with labelled data in R, check out this article: https://www.pipinghotdata.com/posts/2020-12-23-leveraging-labelled-data-in-r/.

```{r}
## convert column labels to column names
bjs <- sjlabelled::label_to_colnames(bjs_raw) %>%
  ## convert labelled variables to factors
  mutate_if(haven::is.labelled, haven::as_factor) 
skim(bjs)

## inspect the "private" operator variables more
table(bjs$`Facility operator`)
## what % of the facilities in the BJS data set are privately operated?
round((table(bjs$`Facility operator`) / nrow(bjs))*100, 2)

## merge the two data sets together
merged_df <- filtered_data %>% 
  ## UCLA variable named "BJS.ID" matches up to BJS variable "Facility ID #1" 
  left_join(bjs, 
            by = c("BJS.ID" = "Facility ID #1")) 

## view the merged data set
#View(merged_df)
```

## Disaggregate data by facility type

### Public/private status

Now, that we have merged the UCLA COVID-19 dataset with the BJS facility information dataset, we can create plots and analyses exploring facility-level infection rates by facility operator type. We utilize the BJS specification of facility operator to group facilities by private and non-private status.


```{r, message=FALSE, warning=FALSE}
## QUESTION - should we include this section?? not sure how helpful it is

## how many of the observations in the ucla data set are privately operated?
table(merged_df$`Facility operator`)

merged_out <- merged_df %>%
  filter(!is.na(`Facility operator`)) %>% ## rm observations with missing facility operator classification
  mutate(is_private = ifelse(`Facility operator` == "Private contractor",
                          TRUE,
                          FALSE))

table(merged_out$is_private)

ggplot(merged_out, 
       aes(x = Population.Feb20, 
           y = confirmed_rate,
           color = is_private
           # color = `Facility operator`
           )) + 
    geom_point() + 
  scale_x_continuous(trans='log') +
  scale_y_continuous(trans='log')
```

### Gender

Next, we compare facilities infection rates and deaths along another axis: facility gender. Comparing the data UCLA collects from women's facilities to non-women's facilities (which includes men's and mixed gender facilities) helps show how the pandemic has impacted a particularly vulnerable group inside. 

```{r, message=FALSE, warning=FALSE}
## notice how few women's prisons there are 
table(filtered_data$Gender)

## combine "mens" and "mixed"
gender_dat <- filtered_data %>%
  mutate(gender_combined = ifelse(Gender == "Female",
                                  "Women",
                                  "Mixed")) %>%
  filter(!is.na(gender_combined)) ## rm observations with missing gender classification
  
## summarize by group
gender_dat %>%
  group_by(gender_combined) %>%
  summarise(n = n(),
            mean_pop = mean(Population.Feb20, na.rm = TRUE),
            mean_cumulative_cases = mean(Residents.Confirmed, na.rm = TRUE), 
            mean_case_rate = mean(confirmed_rate, na.rm = TRUE),
            sum_deaths = sum_na_rm(Residents.Deaths))
```

Let's create a plot comparing the infection rate and population by aggregate gender. 

```{r, message=FALSE, warning=FALSE}
## notice that women's prisons have smaller populations
gender_plot <- ggplot(gender_dat, 
       aes(x = Population.Feb20, 
           y = confirmed_rate,
           color = gender_combined)) + 
    geom_point() 
gender_plot
```

Both the x-axis and the y-axis have most values grouped at the beginning of the scale, and a few outliers with very high populations and infection rates. Let's try putting the x- and y- axes on a log scale to bget a better look at what's going on in the data!

```{r, message=FALSE, warning=FALSE}
## not sure whether or not to actually include this...............
gender_plot + 
  # Log transformation using scale_x/y_continuous()
  # ?scale_x_continuous to see built-in transformations
  scale_x_continuous(trans='log') +
  scale_y_continuous(trans='log')
```

DISCUSS: What are your questions after looking at this plot? What questions, if any, does it answer?

## County-level Comparison

Next, we'll show how to use our historical COVID-19 data from carceral facilities to make comparisons between the infection rate inside of prison and in the surrounding county over time. We use the New York Times' COVID-19 data of cumulative cases and deaths in the US population on the county-level, available to the public here: https://github.com/nytimes/covid-19-data. 

```{r, message=FALSE, warning=FALSE}
## read in the NYT data
us_counties_df <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/" %>%
   # str_c("us.csv") %>% # uncomment this for overall US data
  str_c("us-counties.csv") %>%
  read_csv(col_types = cols()) %>%
  select(Date = date, 
         Confirmed = cases, 
         Deaths = deaths,
         State = state,
         County.FIPS = fips,
         County = county) %>%
  mutate(Name = "County Population")
```
We'll use the California historical data to compare the COVID-19 infection rates over time in one prison to the surrounding county. 

```{r, message=FALSE, warning=FALSE}
## how many observations do we have for each prison in California? 
ca_historical %>%
  count(Name) %>% 
  arrange(desc(n))

## select a prison to focus on! 
## CALIFORNIA STATE PRISON CORCORAN had ~4 separate outbreaks, could use that one
focus_prison <- "CALIFORNIA CORRECTIONAL INSTITUTION"

## subset the data to the focus prison
ca_focus <- ca_historical %>%
  filter(Name == focus_prison) %>%
  ## rename historical population variable
  rename(Population = Residents.Population) %>%
  mutate(County.FIPS = as.character(County.FIPS),
         County.FIPS = stringr::str_pad(County.FIPS, 5, pad = "0")) %>%
  arrange(Date) %>%
  ## estimate active infections from cumulative count
  mutate(Active = diff_roll_sum(Residents.Confirmed, Date)) 
  
head(ca_focus)
```
Now, we want to bind the county-level infection rate data with the UCLA prison data in order to make comparisons between COVID-19 outbreaks inside and outside of prison. To do so, we'll need to subset the county-level infection to the county in which our focus prison is located. We add in the total county population in order to calculate comparable rates, and then bind the two data sets together. 

```{r, message=FALSE, warning=FALSE}
## where is this prison located? 
ca_focus %>%
  select(County.FIPS, County)

prison_county_fips <- ca_focus$County.FIPS[1]

## subset NYT data to surrounding county
one_county <- us_counties_df %>% 
  filter(County.FIPS == prison_county_fips) %>%
  ## add total county population: https://www.census.gov/quickfacts/kerncountycalifornia
  mutate(Population = 900202) %>%
  arrange(Date) %>%
  ## estimate active infections from cumulative count
  mutate(Active = diff_roll_sum(Confirmed, Date)) 

county_comparison <- ca_focus %>%
  bind_rows(one_county) %>%
  ## calculate estimated active infection rate
  mutate(Percent = Active / Population)

table(county_comparison$Name)
```

Now that we have a comparable data set with both the focus prison and the surrounding county's estimated active infection rates, we can make a plot. 

```{r, message=FALSE, warning=FALSE, fig.width = 10}
county_comparison %>%
 ggplot(., aes(x = Date, y = Percent, color = Name)) +
  geom_line(size = 2) +
  theme_minimal() + 
  labs(title = "Comparison of CA Prison and Surrounding County with Active Infections", 
       y = "Percent of Population Actively Infected") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(color = "")
```

## Data FAQs



